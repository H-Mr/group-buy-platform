name: Group Buy Platform CI (Build Stage)

# è§¦å‘æœºåˆ¶ï¼šmainåˆ†æ”¯æ¨é€/PRæ—¶è§¦å‘ï¼ˆPRä»…æ‰§è¡ŒCIï¼Œä¸æ‰§è¡ŒCDï¼‰
on:
  push:
    branches: [ "main" ]  # ç›‘å¬ main åˆ†æ”¯çš„ä»£ç æ¨é€
  pull_request:
    branches: [ "main" ] # ç›‘å¬ main æˆ– master åˆ†æ”¯çš„ PR è¯·æ±‚

jobs:
  # ======================================================
  # Job: æ„å»ºé˜¶æ®µ (Build)
  # build ä»»åŠ¡ï¼šåªè´Ÿè´£ç¼–è¯‘æ‰“åŒ…ã€ç”Ÿæˆé…ç½®æ–‡ä»¶ï¼Œå®Œæˆåå°†äº§ç‰©ï¼ˆJar åŒ… + é…ç½®æ–‡ä»¶ï¼‰ä¸Šä¼ ä¸º GitHub Action çš„ã€Œåˆ¶å“ï¼ˆArtifactï¼‰ã€ï¼›
  # èŒè´£ï¼šä»£ç æ£€å‡º -> ç¼–è¯‘ -> æ•´ç†æ–‡ä»¶ -> ä¸Šä¼ å·¥ä»¶
  # ======================================================
  build:
    # æŒ‡å®šè¿è¡Œç¯å¢ƒï¼šä½¿ç”¨ GitHub æä¾›çš„æœ€æ–°ç‰ˆ Ubuntu è™šæ‹Ÿæœº
    runs-on: ubuntu-latest
    #================ CI æ„å»ºé˜¶æ®µ ==================
    steps:
      # ç¬¬ä¸€æ­¥ï¼šå»ä½ çš„ä»“åº“æŠŠä»£ç ä¸‹è½½åˆ°è¿™å°±è™šæ‹Ÿæœºä¸Š
      - name: Checkout code
        uses: actions/checkout@v4

      # ç¬¬äºŒæ­¥ï¼šåœ¨è¿™å°è™šæ‹Ÿæœºä¸Šå®‰è£… Java 8
      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'       # æŒ‡å®šå®‰è£… JDK 8
          distribution: 'temurin' # ä½¿ç”¨ Eclipse Temurin å‘è¡Œç‰ˆ (æ¨èï¼Œæœ€ç¨³)
          cache: maven            # ã€å…³é”®ã€‘å¼€å¯ Maven ç¼“å­˜ï¼Œä¸‹æ¬¡æ„å»ºä¸ç”¨é‡æ–°ä¸‹è½½ jar åŒ…ï¼Œé€Ÿåº¦é£å¿«

      # ç¬¬ä¸‰æ­¥ï¼šæ‰§è¡Œ Maven æ‰“åŒ…å‘½ä»¤
      # ç›¸å½“äºåœ¨æœ¬åœ°æ‰§è¡Œ mvn clean packageï¼Œ-DskipTests è·³è¿‡å•å…ƒæµ‹è¯•ï¼ŒåŠ å¿«æ„å»ºé€Ÿåº¦
      - name: Build with Maven
        run: mvn clean package -DskipTests

      # ç¬¬å››æ­¥ï¼šé‡å‘½åjaråŒ…
      # ç¼–è¯‘å¥½çš„ jar åŒ…åŸæœ¬åœ¨ target/ ç›®å½•ä¸‹ï¼Œåå­—å¸¦ç‰ˆæœ¬å·ï¼Œ
      # æˆ‘ä»¬æŠŠå®ƒé‡å‘½åä¸º app.jar å¹¶æ”¾åœ¨æ ¹ç›®å½•ï¼Œæ–¹ä¾¿åç»­ scp ä¼ è¾“
      - name: Prepare Jar file
        run: |
          JAR_FILE=$(find target -name "*.jar" ! -name "*-sources.jar" ! -name "*-test.jar" | head -n 1)
          if [ -z "$JAR_FILE" ]; then
            echo "Error: æœªæ‰¾åˆ°å¯æ‰§è¡ŒJaråŒ…ï¼"
            exit 1
          fi
          mv "$JAR_FILE" app.jar
          echo "æˆåŠŸæ•´ç†JaråŒ…ï¼š$JAR_FILE â†’ app.jar"
        #  mv target/*.jar app.jar

      # ç¬¬äº”æ­¥ï¼šå½’æ¡£CDéœ€è¦çš„æ„å»ºäº§ç‰©ï¼ˆä¸Šä¼ ä¸ºGitHub Actionåˆ¶å“ï¼‰
      - name: Archive build artifacts
        run: |
          # åˆ›å»ºä¸´æ—¶ç›®å½•å­˜æ”¾æ„å»ºäº§ç‰©
          mkdir -p artifact_staging
          # 1. å¤åˆ¶ app.jar åˆ°ä¸´æ—¶ç›®å½•
          cp app.jar artifact_staging/app.jar
          # 2. æ‹·è´ Docker ç›¸å…³æ–‡ä»¶
          cp Dockerfile artifact_staging/
          cp docker-compose.yml artifact_staging/
          # 3. æ‹·è´ SQL è„šæœ¬ç›®å½•
          cp -r sql artifact_staging/
          # 4. æ‹·è´é…ç½®æ¨¡æ¿ (é‡å‘½åä¸º template.yml ä»¥ç¤ºåŒºåˆ«)
          cp src/main/resources/application-prod.yml artifact_staging/template-prod.yml
          # å°† scripts ç›®å½•ä¸‹çš„æ‰€æœ‰ .sh æ–‡ä»¶å¤åˆ¶è¿›å»
          cp scripts/*.sh artifact_staging/
          echo "æˆåŠŸæ‰“åŒ…æ„å»ºäº§ç‰©ä¸º build_artifacts.tar.gz"
          
          

        # ç¬¬6æ­¥ï¼šä¸Šä¼ æ„å»ºäº§ç‰©ä¸º GitHub Action åˆ¶å“ï¼ˆArtifactï¼‰
        # è¿™å°†æŠŠ artifact_staging ç›®å½•ä¸‹çš„æ‰€æœ‰å†…å®¹æ‰“åŒ…å­˜å‚¨åœ¨ GitHub æœåŠ¡å™¨ä¸Š
        # ä¾›ä¸‹ä¸€ä¸ª Job (deploy) ä¸‹è½½ä½¿ç”¨
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: deploy-package
          path: artifact_staging/
          retention-days: 1 # ä¸´æ—¶æ–‡ä»¶åªä¿ç•™1å¤©ï¼ŒèŠ‚çœç©ºé—´

  # ======================================================
  # Job 2: éƒ¨ç½²é˜¶æ®µ (Deploy)
  # èŒè´£ï¼šä¸‹è½½å·¥ä»¶ -> æ³¨å…¥å¯†é’¥ -> SCPä¼ è¾“ -> SSHé‡å¯
  # ======================================================
  deploy:
    # deploy ä»»åŠ¡ï¼šä¾èµ– build ä»»åŠ¡ï¼ˆneeds: buildï¼‰ï¼Œä»…å½“ build æˆåŠŸåæ‰æ‰§è¡Œï¼Œå…ˆä¸‹è½½ build ä¸Šä¼ çš„åˆ¶å“ï¼Œå†é€šè¿‡ SSH éƒ¨ç½²åˆ°æœåŠ¡å™¨ã€‚
    runs-on: ubuntu-latest
    needs: build  # å…³é”®ï¼šä»…å½“buildä»»åŠ¡æˆåŠŸåï¼Œæ‰æ‰§è¡Œdeploy
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'  # ä»…mainåˆ†æ”¯æ¨é€æ—¶æ‰§è¡Œéƒ¨ç½²ï¼ˆPRä¸æ‰§è¡Œï¼‰
    steps:
      # 1. ä¸‹è½½å·¥ä»¶
      # ä» GitHub å­˜å‚¨åŒºæŠŠä¸Šä¸€æ­¥æ‰“åŒ…çš„ deploy-package ä¸‹è½½ä¸‹æ¥
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: deploy-package
          # ä¸‹è½½åˆ°å½“å‰å·¥ä½œç›®å½• (ä¼šè‡ªåŠ¨è§£å‹)

      # 2. æ£€æŸ¥ä¸‹è½½ç»“æœ (è°ƒè¯•ç”¨)
      - name: Display structure of downloaded files
        run: ls -R

      # 3. ç”Ÿæˆç”Ÿäº§ç¯å¢ƒé…ç½® (æ³¨å…¥ Secrets)
      # æ³¨æ„ï¼šæ­¤æ—¶è¯»å–çš„æ˜¯ä¸‹è½½ä¸‹æ¥çš„ template-prod.yml
      - name: Generate application-prod.yml and docker-compose.yml
        env:
          # å¿…é¡»åœ¨è¿™é‡ŒæŠŠ Secrets æ˜ å°„ä¸ºç¯å¢ƒå˜é‡ï¼Œenvsubst æ‰èƒ½è¯»å–åˆ°
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          WEIXIN_APP_SECRET: ${{ secrets.WEIXIN_APP_SECRET }}
          ALIPAY_PRIVATE_KEY: ${{ secrets.ALIPAY_PRIVATE_KEY }}
        run: |
          # æ­¤æ—¶ template-prod.yml å°±åœ¨å½“å‰æ ¹ç›®å½•
          # æˆ‘ä»¬ç”Ÿæˆæœ€ç»ˆçš„ application-prod.yml
          # ä½¿ç”¨ envsubst è¿›è¡Œæ›¿æ¢
          # é€šè¿‡ envsubst '${VAR1} ${VAR2}' è¿™ç§å†™æ³•ï¼Œæˆ‘ä»¬è¦å‘Šè¯‰å®ƒï¼šâ€œåªæ›¿æ¢æˆ‘æŒ‡å®šçš„è¿™å‡ ä¸ªå˜é‡ï¼Œå…¶ä»–çš„ ${...} ç»™æˆ‘åŸæ ·ä¿ç•™ï¼â€
          envsubst '${SERVER_HOST} ${MYSQL_ROOT_PASSWORD} ${REDIS_PASSWORD} ${JWT_SECRET} ${WEIXIN_APP_SECRET} ${ALIPAY_PRIVATE_KEY}' \
            < template-prod.yml \
            > application-prod.yml
          echo "æˆåŠŸç”Ÿæˆéƒ¨ç½²é…ç½®æ–‡ä»¶ application-prod.yml"
          
           # å¤„ç† docker-compose.ymlï¼ˆæ›¿æ¢æ•æ„Ÿå˜é‡ï¼‰
          envsubst '${MYSQL_ROOT_PASSWORD} ${REDIS_PASSWORD}' \
          < docker-compose.yml \
          > docker-compose.prod.yml
          # æ›¿æ¢åŸæ–‡ä»¶ï¼ˆåç»­éƒ¨ç½²ä½¿ç”¨æ›¿æ¢åçš„æ–‡ä»¶ï¼‰
          mv -f docker-compose.prod.yml docker-compose.yml
          echo "âœ… ç”Ÿæˆå«æ•æ„Ÿä¿¡æ¯çš„ docker-compose.yml"
          
          rm template-prod.yml # åˆ é™¤æ¨¡æ¿æ–‡ä»¶ï¼Œä¸ä¼ è¾“ç»™æœåŠ¡å™¨
          echo "âœ… ç”Ÿäº§ç¯å¢ƒé…ç½®ç”ŸæˆæˆåŠŸ"

      # 4. ä¼ è¾“æ–‡ä»¶åˆ°æœåŠ¡å™¨ (SCP)
      # åœ¨ä¼ è¾“æ–‡ä»¶å‰ï¼Œå…ˆæ£€æŸ¥æœåŠ¡å™¨ç›®å½•æ˜¯å¦å­˜åœ¨
      # è¿™å¯ä»¥è§£å†³ç¬¬ä¸€æ¬¡éƒ¨ç½²æ—¶ "No such file" çš„é—®é¢˜
      - name: Check server directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # å¦‚æœç›®å½•ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºå¹¶èµ‹æƒ
            if [ ! -d "/opt/group-buy-platform" ]; then
              echo "ç›®å½•ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º..."
              # å¦‚æœä½ æ˜¯ root ç”¨æˆ·ç™»å½•ï¼Œç›´æ¥åˆ›å»º
              mkdir -p /opt/group-buy-platform
            fi
      # æ–°å¢ï¼šæ‰“åŒ…æ–‡ä»¶ï¼ˆæ”¾åœ¨SCPæ­¥éª¤å‰ï¼‰
      - name: Package all files for SCP
        run: |
          tar -zcf deploy.tar.gz app.jar Dockerfile docker-compose.yml sql/ application-prod.yml *.sh

      - name: Transfer files to server via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          # æ­¤æ—¶å½“å‰ç›®å½•ä¸‹å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„æ‰€æœ‰æ–‡ä»¶
          source: deploy.tar.gz
          target: /opt/group-buy-platform
          overwrite: true
          port: 22
          timeout: 30s
          command_timeout: 10m

      # æ–°å¢ï¼šæœåŠ¡å™¨ç«¯è§£å‹æ–‡ä»¶ï¼ˆé€šè¿‡SSHæ­¥éª¤ï¼‰
      - name: Unpack files on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /opt/group-buy-platform
            tar -zxf deploy.tar.gz  # è§£å‹
            rm -f deploy.tar.gz     # å¯é€‰ï¼šåˆ é™¤å‹ç¼©åŒ…ï¼Œæ¸…ç†ç©ºé—´
            

      # 5. è¿œç¨‹æ‰§è¡Œéƒ¨ç½² (SSH)
      - name: Deploy application via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "==== å¼€å§‹è‡ªåŠ¨åŒ–éƒ¨ç½² (Split Job) ===="
            # æ£€æŸ¥ Docker/docker-compose æ˜¯å¦å®‰è£…
            if ! command -v docker &> /dev/null; then
            echo "âŒ Docker æœªå®‰è£…ï¼Œè‡ªåŠ¨å®‰è£…..."
            apt update && apt install -y docker.io docker-compose
            systemctl start docker && systemctl enable docker
            fi
            cd /opt/group-buy-platform
            # 5.1 é…ç½®æ–‡ä»¶å½’ä½
            mkdir -p config
            # åˆšæ‰ SCP æŠŠ application-prod.yml ä¼ åˆ°äº†æ ¹ç›®å½•ï¼Œç§»è¿›å»
            mv -f application-prod.yml config/application-prod.yml
            # 5.2 æƒé™å¤„ç†
            mkdir -p logs data/mysql data/redis
            chmod 777 logs
            # ç»™åˆšæ‰ä¼ è¿‡æ¥çš„è„šæœ¬èµ‹äºˆå¯æ‰§è¡Œæƒé™
            chmod +x *.sh
            # 5.3 Docker æ“ä½œ
            echo "ğŸ›‘ é‡å¯å®¹å™¨..."
            docker-compose down || true  # åŠ  || trueï¼Œé¦–æ¬¡éƒ¨ç½²å¤±è´¥ä¸ç»ˆæ­¢
            docker image prune -f
            docker-compose up -d --build

            # 5.4 æ£€æŸ¥æ—¥å¿—
            echo "âœ… éƒ¨ç½²å®Œæˆï¼Œæ—¥å¿—é¢„è§ˆï¼š"
            sleep 5
            docker-compose logs --tail=20 app
            echo "âœ… éƒ¨ç½²å®Œæˆã€‚è¿ç»´äººå‘˜åç»­å¯ä½¿ç”¨ ./start.sh, ./stop.sh ç­‰è„šæœ¬ç®¡ç†æœåŠ¡ã€‚"
